<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aria - AI Voice Assistant</title>
    <meta name="description" content="Aria is your friendly AI IT Support Assistant powered by OpenAI's Realtime API">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.9); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 0.4; }
            100% { transform: scale(0.9); opacity: 0.8; }
        }
        
        @keyframes pulse-ring-outer {
            0% { transform: scale(0.9); opacity: 0.5; }
            50% { transform: scale(1.4); opacity: 0; }
            100% { transform: scale(0.9); opacity: 0.5; }
        }
        
        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .pulse-ring-outer {
            animation: pulse-ring-outer 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .float {
            animation: float 4s ease-in-out infinite;
        }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .gradient-bg {
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #1e1b4b);
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white overflow-x-hidden">
    <div class="container mx-auto px-4 py-8 max-w-3xl min-h-screen flex flex-col">
        
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-400 via-pink-400 to-purple-400 bg-clip-text text-transparent mb-2">
                Aria
            </h1>
            <p class="text-purple-300/80 text-sm">AI IT Support Assistant</p>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col items-center justify-center">
            
            <!-- Avatar Container -->
            <div class="relative mb-8">
                <!-- Outer pulse ring -->
                <div id="pulse-outer" class="absolute inset-[-20px] bg-gradient-to-r from-purple-500/30 to-pink-500/30 rounded-full pulse-ring-outer opacity-0 transition-opacity duration-300"></div>
                
                <!-- Inner pulse ring -->
                <div id="pulse-inner" class="absolute inset-[-10px] bg-gradient-to-r from-purple-500/40 to-pink-500/40 rounded-full pulse-ring opacity-0 transition-opacity duration-300"></div>
                
                <!-- Avatar -->
                <div id="avatar" class="relative w-36 h-36 bg-gradient-to-br from-purple-600 via-pink-500 to-purple-600 rounded-full flex items-center justify-center shadow-2xl shadow-purple-500/30 float">
                    <div class="absolute inset-1 bg-gradient-to-br from-slate-900 to-slate-800 rounded-full"></div>
                    <svg class="relative w-16 h-16 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                </div>
            </div>

            <!-- Status Badge -->
            <div id="status-badge" class="glass rounded-full px-5 py-2.5 mb-8">
                <div class="flex items-center gap-2">
                    <span id="status-dot" class="w-2 h-2 rounded-full bg-slate-500 transition-colors duration-300"></span>
                    <span id="status-text" class="text-sm text-slate-300">Click to start conversation</span>
                </div>
            </div>

            <!-- Transcript Container -->
            <div id="transcript-container" class="w-full glass rounded-2xl p-5 mb-8 max-h-[300px] overflow-y-auto scrollbar-thin hidden">
                <div id="transcript" class="space-y-3"></div>
            </div>

            <!-- Control Buttons -->
            <div class="flex gap-4">
                <button id="start-btn" onclick="startConversation()" 
                    class="group relative px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 rounded-full font-medium transition-all duration-300 transform hover:scale-105 shadow-lg shadow-purple-500/30 hover:shadow-purple-500/50">
                    <span class="flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                        </svg>
                        Start Conversation
                    </span>
                </button>
                
                <button id="stop-btn" onclick="endConversation()" 
                    class="hidden px-8 py-4 bg-slate-700/80 hover:bg-slate-600/80 rounded-full font-medium transition-all duration-300 border border-slate-600">
                    <span class="flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
                        </svg>
                        End Call
                    </span>
                </button>
            </div>

            <!-- Error Toast -->
            <div id="error-toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 bg-red-500/90 backdrop-blur rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 pointer-events-none">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span id="error-text">Error message</span>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center py-4 text-slate-500 text-xs">
            Powered by OpenAI Realtime API
        </footer>
    </div>

    <script>
        // =============================================
        // Configuration
        // =============================================
        const API_BASE_URL = 'http://localhost:8000';

        // =============================================
        // State Management
        // =============================================
        let peerConnection = null;
        let dataChannel = null;
        let audioElement = null;
        let isConnected = false;
        let isSpeaking = false;

        // =============================================
        // DOM Elements
        // =============================================
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const pulseOuter = document.getElementById('pulse-outer');
        const pulseInner = document.getElementById('pulse-inner');
        const transcriptContainer = document.getElementById('transcript-container');
        const transcript = document.getElementById('transcript');
        const errorToast = document.getElementById('error-toast');
        const errorText = document.getElementById('error-text');

        // =============================================
        // UI Helpers
        // =============================================
        function updateStatus(status, color) {
            statusText.textContent = status;
            statusDot.className = `w-2 h-2 rounded-full transition-colors duration-300`;
            
            switch(color) {
                case 'green':
                    statusDot.classList.add('bg-green-500');
                    break;
                case 'yellow':
                    statusDot.classList.add('bg-yellow-500');
                    break;
                case 'red':
                    statusDot.classList.add('bg-red-500');
                    break;
                default:
                    statusDot.classList.add('bg-slate-500');
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorToast.classList.remove('translate-y-20', 'opacity-0');
            errorToast.classList.add('translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                errorToast.classList.add('translate-y-20', 'opacity-0');
                errorToast.classList.remove('translate-y-0', 'opacity-100');
            }, 5000);
        }

        function setSpeaking(speaking) {
            isSpeaking = speaking;
            if (speaking) {
                pulseOuter.classList.remove('opacity-0');
                pulseOuter.classList.add('opacity-100');
                pulseInner.classList.remove('opacity-0');
                pulseInner.classList.add('opacity-100');
            } else {
                pulseOuter.classList.add('opacity-0');
                pulseOuter.classList.remove('opacity-100');
                pulseInner.classList.add('opacity-0');
                pulseInner.classList.remove('opacity-100');
            }
        }

        function addTranscript(role, text) {
            if (!text || text.trim() === '') return;
            
            transcriptContainer.classList.remove('hidden');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user' 
                ? 'bg-purple-600/20 border border-purple-500/30 rounded-xl p-3 ml-8' 
                : 'bg-slate-700/30 border border-slate-600/30 rounded-xl p-3 mr-8';
            
            messageDiv.innerHTML = `
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs font-medium ${role === 'user' ? 'text-purple-400' : 'text-pink-400'}">
                        ${role === 'user' ? 'You' : 'Aria'}
                    </span>
                </div>
                <p class="text-sm text-slate-200 leading-relaxed">${text}</p>
            `;
            
            transcript.appendChild(messageDiv);
            transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
        }

        // =============================================
        // WebRTC Connection
        // =============================================
        async function startConversation() {
            try {
                startBtn.disabled = true;
                updateStatus('Connecting...', 'yellow');

                // Step 1: Get ephemeral token from backend
                console.log('Requesting session token...');
                const tokenResponse = await fetch(`${API_BASE_URL}/api/realtime-session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (!tokenResponse.ok) {
                    const error = await tokenResponse.json();
                    throw new Error(error.detail || 'Failed to get session token');
                }

                const sessionData = await tokenResponse.json();
                const ephemeralKey = sessionData.client_secret?.value;

                if (!ephemeralKey) {
                    throw new Error('No ephemeral key received from server');
                }
                console.log('Session token received');

                // Step 2: Create audio element for playback
                audioElement = document.createElement('audio');
                audioElement.autoplay = true;

                // Step 3: Create RTCPeerConnection
                peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                // Step 4: Handle remote audio track
                peerConnection.ontrack = (event) => {
                    console.log('Received remote track');
                    audioElement.srcObject = event.streams[0];
                };

                // Step 5: Get user's microphone and add to connection
                const mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 24000
                    }
                });
                
                mediaStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, mediaStream);
                });
                console.log('Microphone connected');

                // Step 6: Create data channel for events
                dataChannel = peerConnection.createDataChannel('oai-events');
                
                dataChannel.onopen = () => {
                    console.log('Data channel opened');
                    isConnected = true;
                    updateStatus('Connected - Speak now!', 'green');
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    startBtn.disabled = false;
                };

                dataChannel.onclose = () => {
                    console.log('Data channel closed');
                };

                dataChannel.onmessage = handleDataChannelMessage;

                // Step 7: Create offer and set local description
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // Step 8: Send offer to OpenAI Realtime API
                console.log('Connecting to OpenAI Realtime API...');
                const baseUrl = 'https://api.openai.com/v1/realtime';
                const model = 'gpt-4o-realtime-preview-2024-12-17';

                const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
                    method: 'POST',
                    body: offer.sdp,
                    headers: {
                        'Authorization': `Bearer ${ephemeralKey}`,
                        'Content-Type': 'application/sdp'
                    }
                });

                if (!sdpResponse.ok) {
                    throw new Error(`OpenAI connection failed: ${sdpResponse.status}`);
                }

                // Step 9: Set remote description
                const answerSdp = await sdpResponse.text();
                await peerConnection.setRemoteDescription({
                    type: 'answer',
                    sdp: answerSdp
                });

                console.log('WebRTC connection established!');

            } catch (error) {
                console.error('Connection error:', error);
                showError(error.message);
                updateStatus('Connection failed', 'red');
                startBtn.disabled = false;
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                cleanup();
            }
        }

        function handleDataChannelMessage(event) {
            try {
                const message = JSON.parse(event.data);
                console.log('Event:', message.type);

                switch (message.type) {
                    case 'session.created':
                        console.log('Session created');
                        break;

                    case 'response.audio.delta':
                        setSpeaking(true);
                        break;

                    case 'response.audio.done':
                        setSpeaking(false);
                        break;

                    case 'response.audio_transcript.done':
                        if (message.transcript) {
                            addTranscript('assistant', message.transcript);
                        }
                        break;

                    case 'conversation.item.input_audio_transcription.completed':
                        if (message.transcript) {
                            addTranscript('user', message.transcript);
                        }
                        break;

                    case 'error':
                        console.error('API Error:', message.error);
                        showError(message.error?.message || 'An error occurred');
                        break;
                }
            } catch (e) {
                console.error('Error parsing message:', e);
            }
        }

        function endConversation() {
            cleanup();
            updateStatus('Disconnected', 'slate');
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            setSpeaking(false);
        }

        function cleanup() {
            if (dataChannel) {
                dataChannel.close();
                dataChannel = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (audioElement) {
                audioElement.srcObject = null;
                audioElement = null;
            }
            
            isConnected = false;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', cleanup);
    </script>
</body>
</html>
